pipeline {
  agent any

  environment {
    // docker-compose 에서 주입한 값 사용
    AWS_REGION     = "${env.AWS_REGION}"
    ECR_ACCOUNT_ID = "${env.ECR_ACCOUNT_ID}"
    ECR_REGISTRY   = "${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    ECR_REPO       = "yoitang-frontend"

    KANIKO_IMAGE   = "gcr.io/kaniko-project/executor:v1.24.0"
    DOCKER_CONFIG  = "/var/jenkins_home/.docker"

    TRIVY_SEVERITY       = "CRITICAL,HIGH"
    TRIVY_IGNORE_UNFIXED = "true"
  }

  parameters {
    string(
      name: 'PREFIX',
      description: '도메인 prefix (예: team1)',
      trim: true
    )
    string(
      name: 'GIT_REPO',
      description: '프론트엔드 Git 저장소 URL',
      trim: true
    )
    string(
      name: 'BRANCH',
      defaultValue: 'master',
      description: '배포 브랜치',
      trim: true
    )

    booleanParam(
      name: 'USE_REPO_DOCKERFILE',
      defaultValue: false,
      description: '체크 시 레포 안의 frontend/Dockerfile 그대로 사용'
    )

    choice(
      name: 'FRONTEND_STACK',
      choices: ['react-vite'],
      description: '프론트엔드 스택 (현재는 React(Vite)만 지원)'
    )
  }

  // 공통 함수: 한 줄씩 로그 전송하며 명령 실행
  def sendLogAndExec(stageName, deployId, backendUrl, command) {
    sh "curl -X POST -H \"Content-Type: application/json\" -d '{\"log\": \"[${stageName}] START\", \"stage\": \"${stageName}\"}' \"${backendUrl}/${deployId}\""

    sh """
      BACKEND_URL="${backendUrl}"
      DEPLOY_ID="${deployId}"
      STAGE_NAME="${stageName}"
      STATUS_FILE=\$(mktemp)

      {
        bash -c "
          set -e
          ${command}
        "; echo \$? > "\$STATUS_FILE";
      } 2>&1 | while IFS= read -r line; do
        echo "\$line"
        escaped_line=\$(echo "\$line" | sed 's/\\\\/\\\\\\\\/g; s/\\"/\\\\\\"/g')
        curl -s -X POST -H "Content-Type: application/json" \
             -d "{\\"log\\": \\"\$escaped_line\\", \\"stage\\": \\"\$STAGE_NAME\\"}" \
             "\${BACKEND_URL}/\${DEPLOY_ID}" || echo "Failed to send log line for \$STAGE_NAME" >&2
      done

      COMMAND_EXIT_CODE=\$(cat "\$STATUS_FILE")
      rm "\$STATUS_FILE"
      if [ "\$COMMAND_EXIT_CODE" -ne 0 ]; then exit "\$COMMAND_EXIT_CODE"; fi
    """

    sh "curl -X POST -H \"Content-Type: application/json\" -d '{\"log\": \"[${stageName}] END\", \"stage\": \"${stageName}\"}' \"${backendUrl}/${deployId}\""
  }

  stages {

    // 1) 팀 레포를 app/ 아래에 체크아웃
    stage('Checkout') {
      steps {
        dir('app') {
          script {
            sendLogAndExec(
              "Checkout",
              env.BUILD_NUMBER,
              "https://www.yoitang.cloud/api/deploy/log",
              """
              deleteDir()
              git branch: '${params.BRANCH}', url: '${params.GIT_REPO}'
              echo "[Checkout] app 디렉터리 구조"
              ls -R
              """
            )
          }
        }
      }
    }

    // 2) frontend/ 기준으로 npm ci + eslint
    stage('Install deps & ESLint') {
      steps {
        dir('app/frontend') {
          script {
            sendLogAndExec(
              "Install",
              env.BUILD_NUMBER,
              "https://www.yoitang.cloud/api/deploy/log",
              """
              if [ ! -d . ]; then
                echo "[ERROR] frontend 디렉터리가 없습니다."
                exit 1
              fi

              if [ -f package.json ]; then
                echo "[Node] package.json 발견"
                if [ -f package-lock.json ]; then
                  if ! npm ci; then
                    echo "[WARN] npm ci 실패 → npm install 폴백"
                    npm install
                  fi
                else
                  npm install
                fi

                if npx eslint --version >/dev/null 2>&1; then
                  npx eslint . || exit 1
                fi
              else
                echo "[ERROR] package.json 없음"
                exit 1
              fi
              """
            )
          }
        }
      }
    }

    // 3) ECR 로그인 (Kaniko에서 쓸 도커 config)
    stage('ECR Login (Kaniko용)') {
      steps {
        script {
          sendLogAndExec(
            "ECR Login",
            env.BUILD_NUMBER,
            "https://www.yoitang.cloud/api/deploy/log",
            """
            mkdir -p ${DOCKER_CONFIG}
            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
            """
          )
        }
      }
    }

    // 4) ECR 리포지토리 존재 보장 (없으면 생성)
    stage('Ensure ECR Repositories') {
      steps {
        script {
          sendLogAndExec(
            "Ensure ECR",
            env.BUILD_NUMBER,
            "https://www.yoitang.cloud/api/deploy/log",
            """
            if ! aws ecr describe-repositories --repository-names ${ECR_REPO} --region ${AWS_REGION} >/dev/null 2>&1; then
              aws ecr create-repository --repository-name ${ECR_REPO} --region ${AWS_REGION}
            fi
            """
          )
        }
      }
    }

    // 5) 플랫폼이 관리하는 Dockerfile 생성 (frontend/ 안에)
    stage('Generate Dockerfile (managed)') {
      when { expression { !params.USE_REPO_DOCKERFILE } }
      steps {
        dir('app/frontend') {
          script {
            sendLogAndExec(
              "Generate Dockerfile",
              env.BUILD_NUMBER,
              "https://www.yoitang.cloud/api/deploy/log",
              """
              case '${params.FRONTEND_STACK}' in
                react-vite)
                  cat > Dockerfile << 'EOF'
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build
FROM nginx:1.27-alpine
COPY --from=builder /app/build /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
EOF
                  ;;
                *)
                  echo "[ERROR] 지원하지 않는 FRONTEND_STACK"
                  exit 1
                  ;;
              esac
              """
            )
          }
        }
      }
    }

    // 6) Kaniko로 빌드 & 푸시 (context = app/frontend)
    stage('Build & Push with Kaniko') {
      steps {
        script {
          def tag = "${params.PREFIX}-${env.BUILD_NUMBER}"
          env.IMAGE_FULL = "${ECR_REGISTRY}/${ECR_REPO}:${tag}"
        }

        dir('app/frontend') {
          script {
            sendLogAndExec(
              "Kaniko Build & Push",
              env.BUILD_NUMBER,
              "https://www.yoitang.cloud/api/deploy/log",
              """
              if [ ! -f Dockerfile ]; then
                echo "[ERROR] Dockerfile 없음"; exit 1
              fi
              HOST_JENKINS_HOME="/home/ubuntu/2025softbank-hackathon/infra/jenkins_home"
              docker run --rm -v \${HOST_JENKINS_HOME}/workspace/yoitang-autodeploy/app/frontend:/workspace -v \${HOST_JENKINS_HOME}/.docker:/kaniko/.docker -w /workspace ${KANIKO_IMAGE} --context /workspace --dockerfile Dockerfile --destination ${env.IMAGE_FULL} --single-snapshot
              """
            )
          }
        }
      }
    }

/*
    // 7) Trivy 이미지 스캔
    stage('Trivy Scan') {
      steps {
        sh '''
        echo "[Trivy] 취약점 스캔 시작 → ${IMAGE_FULL}"
        trivy image --severity ${TRIVY_SEVERITY} \
                    --ignore-unfixed=${TRIVY_IGNORE_UNFIXED} \
                    --exit-code 1 \
                    ${IMAGE_FULL} || {
          echo "[Trivy] CRITICAL/HIGH 취약점 발견 → 빌드 실패"
          exit 1
        }
        '''
      }
    }
*/
    // 8) K8s 매니페스트 생성 & 배포
     // 8) K8s 매니페스트 생성 & 배포 + ECR Secret 연동
    stage('Generate K8s Manifests & Deploy') {
      steps {
        script {
          sendLogAndExec(
            "K8s Deploy",
            env.BUILD_NUMBER,
            "https://www.yoitang.cloud/api/deploy/log",
            """
            set -e
            mkdir -p k8s/${params.PREFIX}
            PREFIX=${params.PREFIX}

            cat <<EOF > k8s/\${PREFIX}/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: \${PREFIX}
EOF

            cat <<EOF > k8s/\${PREFIX}/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: \${PREFIX}-frontend-deploy
  namespace: \${PREFIX}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: \${PREFIX}-frontend
  template:
    metadata:
      labels:
        app: \${PREFIX}-frontend
    spec:
      containers:
      - name: frontend
        image: ${env.IMAGE_FULL}
        ports:
        - containerPort: 80
EOF

            cat <<EOF > k8s/\${PREFIX}/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: \${PREFIX}-frontend-svc
  namespace: \${PREFIX}
spec:
  selector:
    app: \${PREFIX}-frontend
  ports:
  - port: 80
    targetPort: 80
EOF

            cat <<EOF > k8s/\${PREFIX}/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: \${PREFIX}-ing
  namespace: \${PREFIX}
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - \${PREFIX}.yoitang.cloud
    secretName: \${PREFIX}-tls
  rules:
  - host: \${PREFIX}.yoitang.cloud
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: \${PREFIX}-frontend-svc
            port:
              number: 80
EOF

            kubectl apply -f k8s/\${PREFIX}/namespace.yaml

            PASSWORD=$(aws ecr get-login-password --region ${AWS_REGION})
            kubectl create secret docker-registry ecr --docker-server=${ECR_REGISTRY} --docker-username=AWS --docker-password="\${PASSWORD}" -n \${PREFIX} --dry-run=client -o yaml | kubectl apply -f -

            kubectl patch serviceaccount default -n \${PREFIX} -p '{"imagePullSecrets":[{"name":"ecr"}]}' || echo "default SA patch 실패"

            kubectl apply -f k8s/\${PREFIX}/deployment.yaml
            kubectl apply -f k8s/\${PREFIX}/service.yaml
            kubectl apply -f k8s/\${PREFIX}/ingress.yaml

            kubectl get pods -n \${PREFIX}
            """
          )
        }
      }
    }

  }
}